#!/bin/sh
set -e

# Post-installation script for sys-scan-graph

# Create configuration directory if it doesn't exist
if [ ! -d /etc/sys-scan-graph ]; then
    mkdir -p /etc/sys-scan-graph
    chmod 755 /etc/sys-scan-graph
fi

# Create default configuration file if it doesn't exist
if [ ! -f /etc/sys-scan-graph/config.yaml ]; then
    cat > /etc/sys-scan-graph/config.yaml << 'EOF'
# Default configuration for sys-scan-graph
# This file is automatically generated during package installation

# Intelligence Layer settings
intelligence:
  enabled: true
  model_provider: "openai"  # Options: openai, anthropic, google
  temperature: 0.1
  max_tokens: 4096

# Security settings
security:
  enable_process_hashing: true
  enable_gpg_signing: false
  drop_privileges: true
  enable_seccomp: true

# Output settings
output:
  format: "json"  # Options: json, ndjson, sarif
  pretty_print: false
  include_provenance: true

# Risk assessment
risk:
  enable_risk_scoring: true
  risk_threshold: "medium"
  emit_risk_score: true
EOF
    chmod 644 /etc/sys-scan-graph/config.yaml
fi

# Create log directory
if [ ! -d /var/log/sys-scan-graph ]; then
    mkdir -p /var/log/sys-scan-graph
    chmod 755 /var/log/sys-scan-graph
fi

# Set up Python virtual environment for Intelligence Layer if needed
if [ ! -d /opt/sys-scan-graph/venv ]; then
    mkdir -p /opt/sys-scan-graph
    python3 -m venv /opt/sys-scan-graph/venv
    /opt/sys-scan-graph/venv/bin/pip install --upgrade pip setuptools wheel

    # Install Intelligence Layer dependencies
    /opt/sys-scan-graph/venv/bin/pip install \
        langchain \
        langgraph \
        openai \
        anthropic \
        google-generativeai \
        || echo "Warning: Some Intelligence Layer dependencies could not be installed"
fi

#DEBHELPER#

exit 0